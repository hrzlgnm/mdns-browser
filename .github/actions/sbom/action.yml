# Copyright 2025 hrzlgnm
# SPDX-License-Identifier: MIT-0

name: Create and scan sbom action
description: Creates and scans the sbom for security vulnerabilities

inputs:
  artifact-name:
    description: "The name of the sbom upload artifact"
    required: true
  current-version:
    description: "The version to generate the report for"
    required: true

runs:
  using: "composite"
  steps:
    - name: üìú Create SBOM
      uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0
      env:
        SYFT_SOURCE_NAME: ${{ github.event.repository.name }}
        SYFT_SOURCE_VERSION: ${{ inputs.current-version }}
      with:
        format: "spdx-json"
        output-file: "sbom.spdx.json"
        artifact-name: ${{ inputs.artifact-name }}

    - name: üîç Scan SBOM
      id: scan
      uses: anchore/scan-action@3c9a191a0fbab285ca6b8530b5de5a642cba332f # v7.2.2
      with:
        sbom: "sbom.spdx.json"
        severity-cutoff: medium
        cache-db: true

    - name: üîç Inspect SARIF report
      if: ${{ runner.os != 'Windows' }}
      shell: bash
      run: |
        jq . ${{ steps.scan.outputs.sarif }}

    - name: üîç Inspect SARIF report
      if: ${{ runner.os == 'Windows' }}
      shell: pwsh
      run: |
        jq . ${{ steps.scan.outputs.sarif }}
