# Copyright 2025 hrzlgnm
# SPDX-License-Identifier: MIT-0

name: Void Linux XBPS Package

on:
  workflow_call:
    inputs:
      tagName:
        description: "The tag name of the release to publish to"
        required: false
        type: string
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  XBPS_ALLOW_RESTRICTED: yes
  XBPS_CHROOT_CMD: ethereal
  XBPS_ALLOW_CHROOT_BREAKOUT: yes

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/hrzlgnm/mdns-browser-void-package-builder:v1@sha256:5c4ee0a32a036881ffa25fcc79f1de12b35ee04667fc1ab729d779bcd16b8755
    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 1

      - name: üîÑ Clone Void Packages and binary bootstrap
        shell: bash
        run: |
          git clone --depth=1 https://github.com/void-linux/void-packages.git ~/void-packages
          cd ~/void-packages
          ln -s / masterdir
          mkdir -p hostdir
          ./xbps-src binary-bootstrap
          mv /root/.cargo hostdir/
          mv /root/.rustup hostdir/

      - name: üìù Extract version from latest release
        if: (!inputs.tagName)
        id: get-version-release
        uses: ./.github/actions/latest-release-info

      - name: üìù Extract version from tauri config
        if: inputs.tagName
        id: get-version-config
        run: |
          CURRENT_VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          echo "version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: üìù Normalize version output
        id: get-version
        run: |
          VERSION="${{ steps.get-version-config.outputs.version || steps.get-version-release.outputs.version }}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: üî¢ Get Source Tarball Checksum
        id: get-checksum
        run: |
          URL="https://github.com/hrzlgnm/mdns-browser/releases/download/mdns-browser-v${{ steps.get-version.outputs.version }}/mdns-browser-v${{ steps.get-version.outputs.version }}.tar.gz.sha256"
          SHA256SUM=$(curl -LfsS "$URL" | cut -d ' ' -f1)
          echo "checksum=$SHA256SUM" >> "$GITHUB_OUTPUT"

      - name: üåÄ  Generate template
        run: |
          mkdir -p ~/void-packages/srcpkgs/mdns-browser
          packaging/void/generate-template.sh \
            "${{ steps.get-version.outputs.version }}" \
            "${{ steps.get-checksum.outputs.checksum }}" \
            > ~/void-packages/srcpkgs/mdns-browser/template

      - name: üìê Lint generated template
        run: |
          cd ~/void-packages
          xlint srcpkgs/mdns-browser/template
          ./xbps-src -I fetch mdns-browser

      - name: ‚ûï Add Custom build-style to void packages
        run: |
          cp "$GITHUB_WORKSPACE/packaging/void/tauri.sh" ~/void-packages/common/build-style/

      - name: üî® Build Package
        if: inputs.tagName
        run: |
          cd ~/void-packages
          ./xbps-src pkg mdns-browser

      - name: üîë Sign repository and package
        if: inputs.tagName
        run: |
          cd ~/void-packages
          echo "${{ secrets.XBPS_REPOSITORY_SIGNING_KEY }}" > private.pem
          xbps-rindex --privkey private.pem --sign --signedby "hrzlgnm@users.noreply.github.com" hostdir/binpkgs
          xbps-rindex --privkey private.pem --sign-pkg hostdir/binpkgs/*.xbps

      - name: üõ°Ô∏è Attest build provenance (publish release only)
        if: inputs.tagName
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: |
            ~/void-packages/hostdir/binpkgs/*

      - name: üöÄ Publish
        if: inputs.tagName
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: mDNS-Browser Release v${{ steps.get-version.outputs.version }}
          append_body: true
          make_latest: false
          generate_release_notes: false
          files: |
            /github/home/void-packages/hostdir/binpkgs/mdns-browser-${{ steps.get-version.outputs.version }}_1.x86_64.xbps
            /github/home/void-packages/hostdir/binpkgs/mdns-browser-${{ steps.get-version.outputs.version }}_1.x86_64.xbps.sig2
            /github/home/void-packages/hostdir/binpkgs/x86_64-repodata
