name: Bump Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version to bump
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      dry-run:
        description: dry-run
        required: true
        type: boolean

jobs:
  update_version:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semver.outputs.semantic-version }}
    env:
      GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
      RULESET: repos/${{github.repository}}/rulesets/4895698
    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - id: semver
        uses: SOLIDSoftworks/semver-tags@fa8963220fb4913aea2b20cc190004de1b79f395 # v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN}}
          tag-prefix: "mdns-browser-v"
          incremented-value: ${{ inputs.version }}
          create-release: false
          dry-run: true

      - name: ‚öôÔ∏èSet up SSH signing key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_SIGNING_KEY }}" > ~/.ssh/id_ed25519_signing
          chmod 600 ~/.ssh/id_ed25519_signing
          git config --global gpg.format ssh
          git config --global user.signingKey ~/.ssh/id_ed25519_signing
          git config --global user.name "hrzlgnm"
          git config --global user.email "hrzlgnm@users.noreply.github.com"

      - name: üîÑUpdate cargo and tauri versions
        run: |
          sed -i '0,/\(version *= *\).*/s//\1"${{ steps.semver.outputs.semantic-version }}"/' Cargo.toml
          sed -i '0,/\(version *= *\).*/s//\1"${{ steps.semver.outputs.semantic-version }}"/' models/Cargo.toml
          sed -i '0,/\(version *= *\).*/s//\1"${{ steps.semver.outputs.semantic-version }}"/' shared_constants/Cargo.toml
          sed -i '0,/\(version *= *\).*/s//\1"${{ steps.semver.outputs.semantic-version }}"/' src-tauri/Cargo.toml
          jq --indent 4 '.version="${{ steps.semver.outputs.semantic-version }}"' src-tauri/tauri.conf.json > tauri.config.json.new && mv tauri.config.json.new src-tauri/tauri.conf.json
          jq --indent 4 '.version="${{ steps.semver.outputs.semantic-version }}"' src-tauri/tauri.android.conf.json > tauri.android.config.json.new && mv tauri.android.config.json.new src-tauri/tauri.android.conf.json
          sed -i '/name = "mdns-browser"/{N;s/\(version *= *\)".*"/\1"'"${{ steps.semver.outputs.semantic-version }}"'"/;}' Cargo.lock
          sed -i '/name = "mdns-browser-ui"/{N;s/\(version *= *\)".*"/\1"'"${{ steps.semver.outputs.semantic-version }}"'"/;}' Cargo.lock
          sed -i '/name = "models"/{N;s/\(version *= *\)".*"/\1"'"${{ steps.semver.outputs.semantic-version }}"'"/;}' Cargo.lock
          sed -i '/name = "shared_constants"/{N;s/\(version *= *\)".*"/\1"'"${{ steps.semver.outputs.semantic-version }}"'"/;}' Cargo.lock

      - name: ‚è≥Temporary disable ruleset enforcement
        run: |
          gh api \
          -H "Accept: application/vnd.github+json" \
          ${RULESET} | jq '.enforcement = "disabled"' | \
          gh api \
          --method PUT \
          -H "Accept: application/vnd.github+json" \
          ${RULESET} \
          --input -

      - name: üíæüè∑Ô∏è‚¨ÜÔ∏è Commit, tag and push
        if: ${{ !inputs.dry-run }}
        run: |
          git add -A
          git commit -S -m "Bump version to ${{ steps.semver.outputs.semantic-version }}"
          git push
          git tag -s -a mdns-browser-v${{ steps.semver.outputs.semantic-version }} -m "mDNS-Browser Release v${{ steps.semver.outputs.semantic-version}}"
          git push --tags

      - name: üëÆ Re-enable enforcement of rules
        if: always()
        run: |
          gh api \
          -H "Accept: application/vnd.github+json" \
          ${RULESET} | jq '.enforcement = "active"' | \
          gh api \
          --method PUT \
          -H "Accept: application/vnd.github+json" \
          ${RULESET} \
          --input -
