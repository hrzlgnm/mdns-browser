name: "Reusable desktop tauri build workflow"

on:
  workflow_call:
    inputs:
      tagName:
        required: false
        type: string
      releaseName:
        required: false
        type: string
    secrets:
      TAURI_PRIVATE_KEY:
        required: true
      TAURI_KEY_PASSWORD:
        required: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: "ubuntu-latest"
            symbol: üêß
            platform: Linux
            container_image: ghcr.io/hrzlgnm/mdns-browser-ubuntu-builder:v1@sha256:41b291e0292a111400ede6b3df9dfb0b1547cf685a89a3cf11b94b4ba120b7f1
          - os: "macos-latest"
            args: "--target universal-apple-darwin"
            symbol: üçè
            platform: macOS
          - os: "windows-latest"
            symbol: ü™ü
            platform: Windows

    name: ${{matrix.symbol}}üî®
    runs-on: ${{matrix.os}}
    container: ${{ contains(matrix.os, 'ubuntu') && matrix.container_image || null }}
    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: üõ°Ô∏è Verify tag matches version in tauri config (publish only)
        if: inputs.tagName != ''
        shell: bash
        run: |
          CURRENT_VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          TAG=${GITHUB_REF#refs/tags/}
          if [[ "$TAG" != *"$CURRENT_VERSION" ]]
          then
            echo "The tag name ${TAG} does not match the version ${CURRENT_VERSION} from tauri config"
            exit 1
          fi

      - name: ü¶Ä Install rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.os == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin,wasm32-unknown-unknown' || 'wasm32-unknown-unknown' }}

      - name: üì¶ Rust cache
        uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2
        with:
          cache-bin: false
          prefix-key: "v1-rust"
          shared-key: "shared"

      - name: üõ†Ô∏è Setup | Install dependencies
        if: matrix.install != ''
        run: ${{ matrix.install }}

      - name: üì• Cached install trunk
        uses: baptiste0928/cargo-install@b687c656bda5733207e629b50a22bf68974a0305 # v3
        with:
          crate: trunk
          version: 0.21.14
          locked: true
          args: --no-default-features
          features: rustls

      - name: üì• Cached install cargo-auditable
        uses: baptiste0928/cargo-install@b687c656bda5733207e629b50a22bf68974a0305 # v3
        with:
          crate: cargo-auditable
          version: 0.7.1
          locked: true

      - name: üì• Cached install tauri-cli
        uses: baptiste0928/cargo-install@b687c656bda5733207e629b50a22bf68974a0305 # v3
        with:
          crate: tauri-cli
          version: 2.9.2
          locked: true

      - name: üì¶ Run sccache non-release runs
        if: inputs.tagName == ''
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: üì¶ Set Rust caching env vars only on non-release runs
        if: inputs.tagName == ''
        shell: bash
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV

      - name: üîë Import windows signing certificate (windows only)
        if: contains(matrix.os, 'windows')
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          New-Item -ItemType directory -Path certificate
          Set-Content -Path certificate/tempCert.txt -Value $env:WINDOWS_CERTIFICATE
          certutil -decode certificate/tempCert.txt certificate/certificate.pfx
          Remove-Item -path certificate -include tempCert.txt
          Import-PfxCertificate -FilePath certificate/certificate.pfx -CertStoreLocation Cert:\CurrentUser\My -Password (ConvertTo-SecureString -String $env:WINDOWS_CERTIFICATE_PASSWORD -Force -AsPlainText)

      - name: üî® Build plain executables action (publish artifacts on release)
        uses: tauri-apps/tauri-action@3b50ac4d4512105f96edbaa78a6e2f9392805589 # v0.5.24
        env:
          RUSTFLAGS: "-D warnings"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: ${{ inputs.tagName }}
          releaseName: ${{ inputs.releaseName }}
          releaseDraft: false
          prerelease: false
          tauriScript: cargo --locked auditable tauri
          args: ${{ matrix.args }} --no-bundle
          retryAttempts: 1
          uploadPlainBinary: true

      - name: üî® Build bundles using tauri action (publish artifacts on release)
        uses: tauri-apps/tauri-action@3b50ac4d4512105f96edbaa78a6e2f9392805589 # v0.5.24
        env:
          RUSTFLAGS: "-D warnings"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: ${{ inputs.tagName }}
          releaseName: ${{ inputs.releaseName }}
          releaseDraft: false
          prerelease: false
          tauriScript: cargo --locked auditable tauri
          args: ${{ matrix.args }}
          retryAttempts: 1

      - name: üî® Build plain executables action (publish artifacts on release)
        uses: tauri-apps/tauri-action@3b50ac4d4512105f96edbaa78a6e2f9392805589 # v0.5.24
        env:
          RUSTFLAGS: "-D warnings"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: ${{ inputs.tagName }}
          releaseName: ${{ inputs.releaseName }}
          releaseDraft: false
          prerelease: false
          tauriScript: cargo --locked auditable tauri
          args: ${{ matrix.args }} --no-bundle
          retryAttempts: 1

      - name: üì§ Upload build artifacts (push or pr builds only)
        if: inputs.tagName == ''
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: "bundles-${{matrix.os}}${{matrix.args}}"
          path: |
            target/**/release/bundle
            target/**/release/mdns-browser*

      - name: üì¶ Compress debug symbols (windows only)
        if: contains(matrix.os, 'windows')
        shell: pwsh
        run: |
          $pdb = 'target/release/mdns_browser.pdb'
          $zip = 'target/release/mdns_browser.pdb.zip'
          if (Test-Path $pdb) {
            Compress-Archive -Path $pdb -DestinationPath $zip -Force
            Write-Output "Compressed $pdb -> $zip"
          } else {
            Write-Error "PDB file not found: $pdb"
            exit 1
          }

      - name: üì§ Upload debug symbols (windows only)
        if: contains(matrix.os, 'windows')
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: "debug-symbols-${{matrix.os}}${{matrix.args}}"
          path: |
            target/release/mdns_browser.pdb.zip

      - name: üì§ Publish debug symbols to release (windows only)
        if: contains(matrix.os, 'windows') && (inputs.tagName != '')
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2
        with:
          files: target/release/mdns_browser.pdb.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ°Ô∏è Attest build provenance (publish release only)
        if: inputs.tagName != ''
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: |
            target/release/bundle/nsis/*
            target/**/release/bundle/macos/*.tar.gz*
            target/**/release/bundle/dmg/*.dmg
            target/release/bundle/deb/*.deb
            target/release/bundle/rpm/*.rpm
            target/**/release/mdns-browser
            target/release/mdns-browser.exe
            target/release/mdns_browser.pdb
            target/release/mdns_browser.pdb.zip

      - name: üìú Create SBOM
        uses: anchore/sbom-action@8e94d75ddd33f69f691467e42275782e4bfefe84 # v0
        with:
          format: "spdx-json"
          output-file: "sbom.spdx.json"
          artifact-name: "sbom.${{ matrix.platform }}.spdx.json"

      - name: üõ°Ô∏è Attest SBOM
        if: inputs.tagName != ''
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3
        with:
          subject-path: ${{
            contains(matrix.os, 'ubuntu') && 'target/release/mdns-browser' ||
            contains(matrix.os, 'windows') && 'target/release/mdns-browser.exe' ||
            contains(matrix.os, 'macos') && 'target/universal-apple-darwin/release/mdns-browser'
            }}
          sbom-path: "sbom.spdx.json"
