name: "Reusable android workflow"

on:
  workflow_call:
    inputs:
      branch:
        required: false
        type: string
        default: ""
      tagName:
        required: false
        type: string
    secrets:
      ANDROID_RELEASE_KEYSTORE:
        required: false
      ANDROID_RELEASE_KEYSTORE_PASSWORD:
        required: false
      ANDROID_RELEASE_KEY:
        required: false
      ANDROID_RELEASE_KEY_PASSWORD:
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    name: üì¶üî®
    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: üõ°Ô∏è Verify tag matches version in tauri config (publish only)
        if: inputs.tagName
        shell: bash
        run: |
          CURRENT_VERSION=$(jq -r '.version' src-tauri/tauri.android.conf.json)
          TAG=${GITHUB_REF#refs/tags/}
          if [[ "$TAG" != *"$CURRENT_VERSION" ]]
          then
            echo "The tag name ${TAG} does not match the version ${CURRENT_VERSION} from tauri config"
            exit 1
          fi

      - name: ü¶ÄüöÄ
        uses: ./.github/actions/setup-rust-cache
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android,wasm32-unknown-unknown
          save-cache: ${{ inputs.branch == 'main' }}

      - name: üõ†Ô∏èüêÇ
        uses: ./.github/actions/setup-tauri

      - name: üõ†Ô∏èüöÄ
        if: (!inputs.tagName)
        uses: ./.github/actions/setup-sccache

      - name: ‚òï Setup Java
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5
        with:
          distribution: "zulu"
          java-version: "17"

      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3

      - name: üõ†Ô∏è Install NDK
        run: sdkmanager "ndk;27.0.11902837"

      - name: üî® Build app bundle
        run: |
          cargo --locked auditable tauri android init
          cp -a src-tauri/icons/android/mipmap-* src-tauri/gen/android/app/src/main/res/
          cargo --locked auditable tauri android build
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/27.0.11902837
          RUSTFLAGS: "-D warnings"

      - name: üîë Extract android signing key
        run: |
          echo "${{ secrets.ANDROID_RELEASE_KEYSTORE }}" > src-tauri/gen/android/release.jks.base64
          base64 -d src-tauri/gen/android/release.jks.base64 > src-tauri/gen/android/release.decrypted.jks

      - name: üîè Sign APK
        run: |
          ${{ env.ANDROID_HOME }}/build-tools/34.0.0/apksigner sign --ks src-tauri/gen/android/release.decrypted.jks \
            --ks-key-alias ${{ secrets.ANDROID_RELEASE_KEY }} \
            --ks-pass pass:${{ secrets.ANDROID_RELEASE_KEYSTORE_PASSWORD }} \
            --key-pass pass:${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }} \
            --out src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-signed.apk \
            src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk

      - name: üì§ Upload build artifacts (if not publishing)
        if: (!inputs.tagName)
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: "signed-apk"
          path: |
            src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-signed.apk

      - name: üìù Extract version from tauri.android.conf.json
        id: get-version
        run: |
          CURRENT_VERSION=$(jq -r '.version' src-tauri/tauri.android.conf.json)
          echo "current-version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: ‚úèÔ∏è Rename APK file
        run: |
          mv ./src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-signed.apk ./src-tauri/gen/android/app/build/outputs/apk/universal/release/mdns-browser_${{ steps.get-version.outputs.current-version }}.apk

      - name: üöÄ Publish (publish only)
        if: inputs.tagName
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe # v2
        with:
          name: mDNS-Browser Release v${{ steps.get-version.outputs.current-version }}
          append_body: true
          make_latest: false
          generate_release_notes: false
          files: |
            src-tauri/gen/android/app/build/outputs/apk/universal/release/mdns-browser_${{ steps.get-version.outputs.current-version }}.apk

      - name: üõ°Ô∏è Attest build provenance (publish only)
        if: inputs.tagName
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: |
            src-tauri/gen/android/app/build/outputs/apk/universal/release/mdns-browser_${{ steps.get-version.outputs.current-version }}.apk

      - name: üìù Extract version from tauri.conf.json
        id: get-version
        run: |
          CURRENT_VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          echo "current-version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: üìú Create SBOM
        uses: anchore/sbom-action@8e94d75ddd33f69f691467e42275782e4bfefe84 # v0
        env:
          SYFT_SOURCE_NAME: ${{ github.repository_name }}
          SYFT_SOURCE_VERSION: ${{ steps.get-version.outputs.current-version }}
        with:
          format: "spdx-json"
          output-file: "sbom.spdx.json"
          artifact-name: "sbom.android.spdx.json"

      - name: üõ°Ô∏è Attest SBOM (publish only)
        if: inputs.tagName
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3
        with:
          subject-path: src-tauri/gen/android/app/build/outputs/apk/universal/release/mdns-browser_${{ steps.get-version.outputs.current-version }}.apk

          sbom-path: "sbom.spdx.json"
